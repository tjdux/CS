- 전송 계층
  - IP의 한계 극복: 신뢰할 수 있는 통신 & 연결형 통신 가능
  - 응용 계층의 애플리케이션 프로세스 식별: 포트 번호
<br/>

## IP의 한계 
- 1️⃣ 신뢰할 수 없는 (비신뢰성) 프로토콜 (unreliable protocol)
  - IP 프로토콜이 패킷이 수신지까지 제대로 전송되었다는 보장을 하지 않는 특징
  - 통신 과정에서 패킷의 데이터가 손상되거나 중복된 패킷이 전송되었더라도 이를 확인하지 않고, 재전송도 하지 않으며, 순서대로 패킷이 도착할 것이라는 보장 ❌
  - 최선형 전달 (best effort delivery)라고도 함: '최선을 다해 보겠지만, 전송 결과에 대해서는 어떠한 보장도 하지 않는다.'
- 2️⃣ 비연결형 통신 (connectionless protocol)
  - 송수신 호스트 간에 사전 연결 수립 작업을 거치지 않는 특징
  - 그저 수신지를 향해 패킷을 보내기만 할 뿐
- IP 프로토콜이 신뢰할 수 없는 프로토콜 & 비연결형 통신을 하는 이유
  - 성능을 위해서 
  - 패킷이 제대로 전송되었는지 일일이 확인하고, 호스트간 연결을 수립하는 작업은 패킷의 빠른 송수신과는 배치되는 작업
<br/>

## IP의 한계를 극복하는 전송 계층
- TCP
  - 신뢰성 있는 통신 가능
    - 패킷이 수신지까지 올바른 순서대로 확실히 전달되는 것을 보장
    - 재전송을 통한 오류 제어, 흐름 제어, 혼잡 제어 등 다양한 기능들을 제공
  - 연결형 통신 가능
    - 두 호스트가 정보를 주고받기 전에 마치 가상의 회선을 설정하듯이 연결을 수립
    - 송수신하는 동안에는 연결을 유지하고, 송수신이 끝나면 연결을 종료
- UDP
  - 신뢰할 수 없는 통신, 비연결형 통신을 가능하게 하는 전송 계층의 프로토콜
  - 때로는 성능을 위해 신뢰할 수 없는 통신, 비연결형 통신을 지원하는 프로토콜이 필요할 때가 있음 (e.g. 동영상 스트리밍 서비스)
  - TCP보다 빠른 전송
<br/>

## 응용 계층과의 연결 다리, 포트
- 포트의 정의
  - 패킷의 최종 수신 대상은 특정 애플리케이션 프로세스
  - 포트: 패킷이 실행 중인 특정 애플리케이션까지 전달되기 위해 특정 애플리케이션을 식별할 수 있는 정보
- **포트의 분류**
  - 포트 번호
    - 포트 번호를 통해 특정 애플리케이션 식별
    - 패킷 내 수신지 포트, 송신지 포트가 명시
    - 16비트로 표현 가능: 사용 가능한 포트의 수는 $$2^{16}$$(65536) (0번 - 65535번)
  - 포트 번호 분류
    |포트 종류|포트 번호 범위|설명|
    |---|---|---|
    |잘 알려진 포트<br/>(well known port)|0 ~ 1023|범용적으로 사용되는 애플리케이션 프로토콜이 일반적으로 사용하는 '널리 알려진, 유명한' 포트|
    |등록된 포트<br/>(registered port)|1024 ~ 49151|잘 알려진 포트에 비해서는 덜 범용적이지만, 흔히 사용되는 애플리케이션 프로토콜에 할당|
    |동적 포트<br/>(dynamic port)|49152 ~ 65535|자유롭게 사용 가능|
    - 잘 알려진 포트 예시
      |잘 알려진 포트 번호|설명|
      |---|---|
      |20, 21|FTP|
      |22|SSH|
      |23|TELNET|
      |53|DNS|
      |67, 68|DHCP|
      |80|HTTP|
      |443|HTTPS|
    - 등록된 포트 예시
      |등록된 포트 번호|설명|
      |---|---|
      |1194|OpenVPN|
      |1433|Microsoft SQL Server 데이터베이스|
      |3306|MySQL 데이터베이스|
      |6379|Redis|
      |8080|HTTP 대체|
    - 잘 알려진 포트, 등록된 포트는 인터넷 할당 번호 관리 기관(IANA)에 의해 할당
    - 서버로 동작하는 프로그램: 잘 알려진 포트와 등록된 포트로 동작하는 경우가 많음
    - 클라이언트로 동작하는 프로그램: 동적 포트 번호 중 임의의 번호가 할당되는 경우가 많음
- **<IP 주소: 포트 번호> 형식**:IP주소 + 포트 번호 => 특정 호스트에서 실행 중인 특정 애플리케이션 프로세스 식별 가능
<br/>

## 포트 기반 NAT
- NAT
  - IP 주소를 변환하는 기술
  - 주로 네트워크 내부에서 사용되는 사설 IP 주소 ↔ 네트워크 외부에서 사용되는 공인 IP 주소 변환에 사용
  - NAT 변환 테이블 사용
- NAT 변환 테이블
  |네트워크 외부|네트워크 내부|
  |---|---|
  |1.2.3.4|192.168.0.5|
  |1.2.3.5|192.168.0.6|
  |...|...|
  - 변환의 대상이 되는 IP 주소 쌍이 명시
  - 단점: 많은 공인 IP 주소가 필요
    - 변환이 되는 IP 주소가 일대일로 대응: 사설 IP 주소 하나당 공인 IP 주소 하나가 대응
    - 사설 IP 주소만큼 공인 IP 주소 필요 
  - 오늘날에는 다수의 사설 IP 주소를 그보다 적은 수의 공인 IP 주소로 변환
- NAPT
  - 포트 기반의 NAT
  - 포트를 활용해 하나의 공인 IP 주소를 여러 사설 IP 주소가 공유할 수 있도록 하는 NAT의 일종
  - 변환할 IP 주소 쌍과 더불어 포트 번호도 함께 기록하고 변환
  
  |네트워크 외부|네트워크 내부|
  |---|---|
  |1.2.3.4:6200|192.168.0.5:1025|
  |1.2.3.5:6201|192.168.0.6:1026|
  |...|...|
  - 네트워크 외부에서 사용하는 IP 주소가 같더라도 포트 번호가 다르면 네트워크 내부의 호스트 특정 가능
  - 네트워크 내부에서 사용할 IP 주소와 네트워크 외부에서 사용할 IP 주소를 N:1로 관리 가능
  - 공인 IP 주소 수 부족 문제를 개선 
<br/>

## 포트 포워딩 (port forwarding)
- 네트워크 내 특정 호스트에 IP 주소와 포트 번호를 미리 할당하고, 해당 IP 주소:포트 번호로써 해당 호스트에게 패킷을 전달하는 기능
- 네트워크 내부 여러 호스트가 공인 IP 주소를 공유하는 상황에서, 네트워크 외부 호스트가 내부로 통신을 시작하는 상황을 가정
  - 처음 패킷을 보내는 네트워크 외부 호스트 입장에서는 어떤 IP 주소 및 포트를 수신지 주소로 삼을지 결정하기 어려울 수 있음
  - 이때 포트 포워딩 사용: 주로 네트워크 외부에서 내부로 통신을 시작할 때, 네트워크 내부의 서버를 외부에서 접속할 수 있도록 접속 정보를 공개하기 위해 자주 사용
<br/>

## ICMP (Internet Control Message Protocol)
- IP의 신뢰할 수 없는 전송 특성과 비연결형 전송 특성을 보완하기 위한 네트워크 계층의 프로토콜
- IP 패킷의 전송 과정에 대한 피드백 메시지 (ICMP 메시지)를 얻기 위해 사용하는 프로토콜
- ICMP 메시지
  - 송신지 호스트에게 전달
  - 타입과 코드로 정의됨
    - ICMP 패킷 헤더에 포함
    - 타입 필드: ICMP 메시지의 유형이 번호로 명시
    - 코드 필드: 구체적인 메시지 내용이 번호로 명시
  - 메시지의 종류
    - 전송 과정에서 발생한 문제 상황에 대한 오류 보고
    <table>
      <tr>
        <th>타입 이름(타입 번호)</th>
        <th>코드 번호</th>
        <th>코드 설명</th>
      </tr>
      <tr>
        <td rowspan="5">수신지 도달 불가 (3): 특정 패킷이 수신지까지 도달할 수 없음</td>
        <td>0</td>
        <td>네트워크 도달 불가</td>
      </tr>
      <tr>
        <td>1</td>
        <td>호스트 도달 불가</td>
      </tr>
      <tr>
        <td>2</td>
        <td>프로토콜 도달 불가: 수신지에서 특정 프로토콜 사용 불가</td>
      </tr>
      <tr>
        <td>3</td>
        <td>포트 도달 불가</td>
      </tr>
      <tr>
        <td>4</td>
        <td>단편화가 필요하지만 DF가 1로 설정되어 단편화할 수 없음</td>
      </tr>
      <tr>
        <td>시간 초과 (11)</td>
        <td>0</td>
        <td>TTL 만료</td>
      </tr>
    </table>
    
    - 네트워크상의 정보 제공 (네트워크에 대한 진단 정보)
    
    |타입 이름 (타입 번호)|코드 번호|코드 설명|
    |---|---|---|
    |에코 요청 (8)|0|에코 요청|
    |에코 응답 (0)|0|에코 요청에 대한 응답|
    |라우터 광고 (9)|0|라우터가 호스트에게 자신을 알림|
- ICMP 기반 명령어
  - 네트워크상의 간단한 문제 진단 또는 테스트를 위해 사용
  - traceroute: 경로 확인
  - ping: 네트워크의 상태를 진단하는 가장 기본적인 명령어
- ⚠️ ICMP는 IP의 신뢰성을 보장하지 않음
  - 신뢰할 수 없는 특성을 보완하는 역할을 할 뿐, IP 프로토콜의 신뢰성을 보장하지는 않음
  - 신뢰성을 완전히 보장하기 위해서는 전송 계층의 프로토콜이 필요 - 네트워크 외부에서 사용하는 IP 주소가 같더라도 포트 번호가 다르면 네트워크 내부의 호스트 특정 가능
  - 네트워크 내부에서 사용할 IP 주소와 네트워크 외부에서 사용할 IP 주소를 N:1로 관리 가능
  - 공인 IP 주소 수 부족 문제를 개선 
<br/>

## 포트 포워딩 (port forwarding)
- 네트워크 내 특정 호스트에 IP 주소와 포트 번호를 미리 할당하고, 해당 IP 주소:포트 번호로써 해당 호스트에게 패킷을 전달하는 기능
- 네트워크 내부 여러 호스트가 공인 IP 주소를 공유하는 상황에서, 네트워크 외부 호스트가 내부로 통신을 시작하는 상황을 가정
  - 처음 패킷을 보내는 네트워크 외부 호스트 입장에서는 어떤 IP 주소 및 포트를 수신지 주소로 삼을지 결정하기 어려울 수 있음
  - 이때 포트 포워딩 사용: 주로 네트워크 외부에서 내부로 통신을 시작할 때, 네트워크 내부의 서버를 외부에서 접속할 수 있도록 접속 정보를 공개하기 위해 자주 사용
- 포트 포워딩은 일반적으로 NAT(Network Address Translation) 환경에서 사용되며, 하나의 공인 IP 주소를 여러 내부 호스트와 공유하는 상황에서 외부에서 특정 내부 호스트에 접근할 수 있도록 설정함.
<br/>

## ICMP (Internet Control Message Protocol)
- IP의 신뢰할 수 없는 전송 특성과 비연결형 전송 특성을 보완하기 위한 네트워크 계층의 프로토콜
- IP 패킷의 전송 과정에 대한 피드백 메시지 (ICMP 메시지)를 얻기 위해 사용하는 프로토콜
- ICMP 메시지
  - 송신지 호스트에게 전달
  - 타입과 코드로 정의됨
    - ICMP 패킷 헤더에 포함
    - 타입 필드: ICMP 메시지의 유형이 번호로 명시
    - 코드 필드: 구체적인 메시지 내용이 번호로 명시
  - 메시지의 종류
    - 전송 과정에서 발생한 문제 상황에 대한 오류 보고
    <table>
      <tr>
        <th>타입 이름(타입 번호)</th>
        <th>코드 번호</th>
        <th>코드 설명</th>
      </tr>
      <tr>
        <td rowspan="5">수신지 도달 불가 (3): 특정 패킷이 수신지까지 도달할 수 없음</td>
        <td>0</td>
        <td>네트워크 도달 불가</td>
      </tr>
      <tr>
        <td>1</td>
        <td>호스트 도달 불가</td>
      </tr>
      <tr>
        <td>2</td>
        <td>프로토콜 도달 불가: 수신지에서 특정 프로토콜 사용 불가</td>
      </tr>
      <tr>
        <td>3</td>
        <td>포트 도달 불가</td>
      </tr>
      <tr>
        <td>4</td>
        <td>단편화가 필요하지만 DF가 1로 설정되어 단편화할 수 없음</td>
      </tr>
      <tr>
        <td>시간 초과 (11)</td>
        <td>0</td>
        <td>TTL 만료</td>
      </tr>
    </table>
    
    - 네트워크상의 정보 제공 (네트워크에 대한 진단 정보)
    
    |타입 이름 (타입 번호)|코드 번호|코드 설명|
    |---|---|---|
    |에코 요청 (8)|0|에코 요청|
    |에코 응답 (0)|0|에코 요청에 대한 응답|
    |라우터 광고 (9)|0|라우터가 호스트에게 자신을 알림|
- ICMP 기반 명령어
  - 네트워크상의 간단한 문제 진단 또는 테스트를 위해 사용
  - traceroute: 경로 확인
  - ping: 네트워크의 상태를 진단하는 가장 기본적인 명령어
- ⚠️ ICMP는 IP의 신뢰성을 보장하지 않음
  - 신뢰할 수 없는 특성을 보완하는 역할을 할 뿐, IP 프로토콜의 신뢰성을 보장하지는 않음
  - 신뢰성을 완전히 보장하기 위해서는 전송 계층의 프로토콜이 필요
